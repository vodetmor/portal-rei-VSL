
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---

    // Checks if the user is the super admin by email. This user has ultimate power.
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@reidavsl.com';
    }

    // Checks if a user is a regular admin (role defined in their user document) AND has verified their email.
    function isVerifiedAdmin() {
      return request.auth != null
        && request.auth.token.email_verified == true
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Combines super admin and verified admin checks. This is the main function to use for admin checks.
    function isAdmin() {
      return isSuperAdmin() || isVerifiedAdmin();
    }

    // Checks if a user has been explicitly granted access to a specific course.
    function hasCourseAccess(courseId) {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)/courseAccess/$(courseId));
    }

    // Checks if a lesson is part of a demo.
    function isLessonDemo(courseId, lessonId) {
        let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
        if (course.isDemoEnabled != true) {
            return false;
        }
        let modules = course.modules;
        for (let i = 0; i < modules.size(); i++) {
            let module = modules[i];
            if (module.lessons != null) {
                let lessons = module.lessons;
                for (let j = 0; j < lessons.size(); j++) {
                    let lesson = lessons[j];
                    if (lesson.id == lessonId) {
                        return module.isDemo == true || lesson.isDemo == true;
                    }
                }
            }
        }
        return false;
    }

    // Determines if a user can interact with lesson content (e.g., comment, react).
    function canInteract(courseId, lessonId) {
      let course = get(/databases/$(database)/documents/courses/$(courseId)).data;
      return isAdmin()
          || hasCourseAccess(courseId)
          || course.isFree == true
          || (course.isDemoEnabled == true && isLessonDemo(courseId, lessonId));
    }


    // --- COLLECTION RULES ---

    // User documents: Can be read by owner or admin. Admins can list/update/delete any.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list, update, delete: if isAdmin();
      allow create: if request.auth != null && request.auth.uid == userId;

      // Subcollections for a user
      match /courseAccess/{courseId} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow write, list: if isAdmin();
      }

      match /demoAccess/{courseId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
          match /lessons/{lessonId} {
               allow read, write: if request.auth != null && request.auth.uid == userId;
          }
      }

      match /progress/{courseId} {
          allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
          allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Layout documents: Can be read by anyone, but only written by admins.
    match /layout/{layoutId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Course documents: Published courses can be listed/viewed by any authenticated user.
    // Admins can do anything. Users with access can view even if not published.
    match /courses/{courseId} {
      allow get: if (resource.data.status == 'published') || (request.auth != null && hasCourseAccess(courseId)) || isAdmin();
      allow list: if (request.query.where.size() == 0 || request.query.where[0][2] == "published") || isAdmin();
      allow write: if isAdmin();

      // Subcollections within a course
      match /lessons/{lessonId} {
        match /comments/{commentId} {
          allow read, list, create, update, delete: if canInteract(courseId, lessonId);

          match /replies/{replyId} {
            allow read, list, create, update, delete: if canInteract(courseId, lessonId);
          }

          match /likes/{userId} {
            allow read, list, create, delete: if canInteract(courseId, lessonId);
          }
        }
        match /reactions/{reactionId} {
          allow read, list, write: if canInteract(courseId, lessonId);
        }
      }
    }

    // Premium links: Can be read by any authenticated user, but only managed by admins.
    match /premiumLinks/{linkId} {
        allow get: if request.auth.uid != null;
        allow list, create, update, delete: if isAdmin();
    }

    // Audit logs: Immutable logs that can only be created and read by admins.
    match /auditLogs/{logId} {
      allow read, list, create: if isAdmin();
      allow update, delete: if false;
    }

    // Generic read-only collections for public content, writable only by admins.
    match /videos/{videoId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /clients/{clientId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    match /skills/{skillId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Contact messages: Can be created by anyone, but only read/deleted by admins.
    match /contactMessages/{messageId} {
      allow create: if true;
      allow read, delete: if isAdmin();
      allow update: if false;
    }
  }
}
